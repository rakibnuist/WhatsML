import{D as Pe,k as n,l as p,s as d}from"./app-B4kV47qU.js";import{t as V}from"./toastComposable-CvcyPmJb.js";import{e as Oe}from"./echoServiceComposable-n1MnmRL6.js";import{u as Ae}from"./modalStore-BgORG3Nn.js";const Be=Pe("chatStore",()=>{const H={voice_message:!0},A=n(!1),w=Ae(),U="/api/whatsapp-web/v1",g=e=>`${U}/${e}`,R=n([]),h=n({}),K=()=>{var e;return(e=R.value)==null?void 0:e.find(s=>s.id===l.value.sessionId)},x=n({limit:10}),i=n([]),l=n(null),X=e=>{let s=e==null?void 0:e.uuid;if(!s){r.value.conversations=!1;return}r.value.conversations=!0,d.get(g(`${s}/chats`),{params:{limit:x.value.limit}}).then(a=>{e.cursor=a.data.cursor,i.value=[...i.value,...a.data.data]}).catch(a=>{console.error(a),A.value=!0}).finally(()=>r.value.conversations=!1)},Y=()=>{r.value.conversations||(r.value.conversations=!0,R.value.forEach(e=>{let s=e.uuid;e.cursor&&d.get(g(`${s}/chats`),{params:{cursor:e.cursor,limit:x.value.limit}}).then(a=>{i.value=[...i.value,...a.data.data],e.cursor=a.data.cursor}).catch(a=>console.error(a)).finally(()=>r.value.conversations=!1)}),r.value.conversations=!1)},Z=e=>{l.value=e,ee(e),l.value.messages=[],j(e),S(e.id)==="group"&&oe(e)},ee=e=>{if(e.unreadCount<=0)return;let s=e.sessionId,a=e.id;!a||!s||d.post(g(`${s}/chats/${a}/read`)).then(t=>{e.unreadCount=0}).catch(t=>console.error(t))},se=e=>(e||(e=l.value),e.picture?e.picture:`https://ui-avatars.com/api/?name=${e==null?void 0:e.name}`),S=(e="")=>{var s;return e||(e=(s=l.value)==null?void 0:s.id),e.includes("@g.us")?"group":e.includes("@s.whatsapp.net")?"number":"unknown"},ae=n({limit:10}),j=e=>{if(r.value.messages||!e&&!l.value)return;e||(e=l.value);let s=e.sessionId,a=e.id;if(!(!s||!a)){if(Object(e).hasOwnProperty("cursor")&&e.cursor===null){console.log("no more messages");return}r.value.messages=!0,d.get(g(`${s}/chats/${a}`),{params:{limit:ae.value.limit,cursor:e.cursor}}).then(function(t){let u=t.data.data;if(u.length>0){let v=[...u.reverse(),...l.value.messages].filter((m,b,O)=>b===O.findIndex(C=>C.key.id===m.key.id));l.value.messages=v}e.cursor=t.data.cursor}).catch(t=>console.error(t)).finally(()=>{r.value.messages=!1})}},te=async()=>{const e={jid:l.value.id,type:S(l.value.id),messageType:o.value.type,message:{}};switch(o.value.type){case"text":e.message={text:o.value.message};break;case"image":e.message={image:o.value.file,caption:o.value.caption??null};break;case"audio":e.message={audio:o.value.file,ptt:!1};break;case"voice":e.messageType="voice",e.message={voice:o.value.file};break;case"video":e.message={video:o.value.file,caption:o.value.caption??null,gifPlayback:!1,ptv:!1};break;case"location":e.message=o.value.message;break;case"document":e.message={document:o.value.file};break;case"template":e.messageType=o.value.template.type,e.message=o.value.template.meta;break;default:console.error("Invalid message type: "+o.value.type);return}F.value&&(e.options={quoted:k.value}),r.value.sendingMessage=!0,d.post(g(`${l.value.sessionId}/messages/send`),e,{headers:{"Content-Type":"multipart/form-data"}}).then(s=>{var a;if(w.close(),["audio","video","image"].includes(o.value.type)){let t=s.data.key.id;h.value[t]=o.value.file}o.value.type="text",o.value.message="",(a=D.value)==null||a.focus(),N()}).finally(()=>{r.value.sendingMessage=!1,B.value=!1,q()}).catch(s=>{var a,t;V.danger(((t=(a=s.response)==null?void 0:a.data)==null?void 0:t.message)||s.message||"Something went wrong!"),console.error(s)})},ne=async e=>{if(h.value[e.key.id])return h.value[e.key.id];if(!e.sessionId)throw new Error("Session ID not found: "+e);try{const s=await d.post(g(`${e.sessionId}/messages/download`),e,{responseType:"blob"}),a=new Blob([s.data],{type:s.headers["content-type"]});return h.value[e.id]=URL.createObjectURL(a),h.value[e.id]}catch(s){return console.error("Error downloading file:",s),null}},oe=e=>{e.groupMetadata||(r.value.groupMetadata=!0,d.get(g(`${e.sessionId}/groups/${e.id}`)).then(function(s){l.value.groupMetadata=s.data}).catch(s=>console.error(s)).finally(()=>{r.value.groupMetadata=!1}))},T=n([]),le=p(()=>f.value.customer_name.length>0||f.value.badge_id?(T.value=i.value.filter(e=>{var s;return f.value.badge_id?e.badge_id===f.value.badge_id:f.value.customer_name.length>0?(s=e.name)==null?void 0:s.toLowerCase().includes(f.value.customer_name.toLowerCase()):!0}),T.value):i.value),J=n([]),E=n([]),ie=n([]),re=n([]),_=n([]),$=n({isOpen:!1}),L=n({isOpen:!1}),B=n(!1),D=n(),k=n(null),f=n({badge_id:null,customer_name:""}),r=n({sendingMessage:!1,messages:!1,conversations:!1,searching:!1,groupMetadata:!1}),o=n({type:"text",message:"",file:null,template:null,location:null}),ue=p(()=>i.value.length>0),ce=p(()=>l.value!==null),F=p(()=>k.value??!1),I=p(()=>{let e=E.value;return P.value.length>0&&(e=e.filter(s=>s.message_template.toLowerCase().includes(P.value.toLowerCase()))),e.map(s=>s.message_template)}),ve=p(()=>{var s;let e=[];return((s=o.value.message)==null?void 0:s.length)>0&&(e=E.value.filter(a=>{var t;return a.message_template.toLowerCase().includes((t=o.value.message)==null?void 0:t.toLowerCase())})),e.map(a=>a.message_template)}),de=p(()=>J.value),ge=()=>{$.value.isOpen=!$.value.isOpen},me=()=>{L.value.isOpen=!L.value.isOpen},q=(e="smooth")=>{setTimeout(()=>{let s=document.querySelector("#scrollContainerRef");s&&s.scrollIntoView({block:"end",behavior:e})},500)},fe=e=>{k.value=e},N=()=>{k.value=null},pe=()=>{i.value=i.value.sort((e,s)=>s.conversationTimestamp-e.conversationTimestamp)},he=e=>_.value.find(s=>s.id===e)??null,ye=async()=>{try{const e=await d.get(route("user.conversations.api","badges"));_.value=e.data}catch(e){console.error(e)}},c=n(0),P=n(""),ke=n(!1),M=n(!1),Ie=n(),be=e=>{(M.value&&c.value<I.value.length-1||c.value<I.value.length-1)&&(c.value=c.value+1)},Me=e=>{c.value>0&&(c.value=c.value-1)},Q=e=>{z(),o.value.message=W(e)},W=e=>{let s={name:l.value.name,phone:l.value.id};return(e==null?void 0:e.replace(/\{([a-z_]+)\}/g,(a,t)=>(s.hasOwnProperty(t)?s[t]:a)??a))??e},Ce=()=>{w.open("quickReplyModal"),M.value=!0},z=()=>{w.close("quickReplyModal"),M.value=!1},we=e=>{let s="";M.value,s=I.value[c.value],Q(s),c.value=-1},Re=e=>{console.log("Activating live chat..."),Oe.connect().private(e).subscribed(()=>console.log("Live chat activated successfully")).listen("LiveChatNotifyEvent",Se).error(s=>console.error(s))},Se=e=>{e.event==="messages.upsert"?Te(e):e.event==="messages.update"?Ee(e):e.event==="chats.upsert"?_e(e):e.event==="chats.update"&&$e(e)},Te=e=>{var u,y;let s=e.sessionId,a=((u=e.data)==null?void 0:u.messages)||[];a.sessionId||(a.sessionId=s);let t=(y=a.key)==null?void 0:y.remoteJid;i.value.forEach(v=>{var m;v.id==t&&v.sessionId==s&&(v.messages.some(O=>{var C,G;return((C=O.key)==null?void 0:C.id)===((G=a.key)==null?void 0:G.id)})||(v.messages.push(a),a.key.fromMe||qe(),((m=l.value)==null?void 0:m.id)===v.id&&q()))})},Ee=e=>{var u,y;let s=e.sessionId,a=((u=e.data)==null?void 0:u.messages)||[],t=(y=a.key)==null?void 0:y.remoteJid;i.value.forEach(v=>{v.id==t&&v.sessionId==s&&(v.messages=v.messages.map(m=>{var b;return((b=m.key)==null?void 0:b.id)==a.id?{...m,...a}:m}))})},_e=e=>{var a;console.log("chats upsert event received",e),(((a=e.data)==null?void 0:a.chats)??[]).forEach(t=>{i.value.find(u=>u.id==t.id)?i.value=i.value.map(u=>u.id==t.id?{...u,...t,sessionId:e.sessionId}:u):i.value.unshift({...t,sessionId:e.sessionId})})},$e=e=>{var a;let s=((a=e.data)==null?void 0:a.chats)??null;s&&(i.value=i.value.map(t=>(t.id==s.id&&(t.conversationTimestamp=s.conversationTimestamp),t)),pe())},Le=()=>{let e=l.value;if(!e)return;let s=e.sessionId,a=e.id;d.get(g(`${s}/chats/${a}/photo`)).then(t=>{e.picture=t.data.url,V.success("Profile picture updated")}).catch(t=>{console.error("Error fetching profile:",t)})},qe=()=>{new Audio("/assets/incoming-message-online-whatsapp.mp3").play()};return{features:H,disconnected:A,baseApiUrl:U,platforms:R,mediaMessages:h,getActivePlatform:K,activeConversation:l,conversations:i,fetchConversations:X,setActiveConversation:Z,getConversationProfilePic:se,getConversationType:S,getMedia:ne,searchedConversationList:T,chatTemplates:J,quickReplies:E,aiTemplates:ie,languages:re,badges:_,rightSidebar:$,leftSidebar:L,replying:k,searchForm:f,loading:r,assetPopup:B,messageInputFieldRef:D,inputMessage:o,quickReplySearchInput:P,quickReplySuggestionItemsShow:ke,arrowCounter:c,hasConversations:ue,hasActiveConversation:ce,isReplying:F,quickReplyFilteredItems:I,quickReplySuggestionItems:ve,getActiveModuleTemplates:de,filteredConversations:le,toggleRightSidebar:ge,toggleLeftSidebar:me,scrollToLastMessage:q,setReplying:fe,unsetReplying:N,loadMoreMessages:j,loadMoreConversations:Y,addQuickReplyToMessageInput:Q,loadBadges:ye,getBadge:he,submitMessage:te,quickReplyModalOpen:Ce,quickReplyModalClose:z,selectQuickReply:we,onArrowDown:be,onArrowUp:Me,replaceTextWithShortCodes:W,quickReplyModalSearchInput:Ie,connectWebSocket:Re,getChatProfilePic:Le}});export{Be as u};
