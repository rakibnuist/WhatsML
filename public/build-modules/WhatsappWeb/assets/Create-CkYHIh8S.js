import{p as X,l as U,k as f,r as Y,c as d,o as i,a as m,f as _,b as t,i as M,t as o,F as V,g as $,w as B,e as b,v as D,h as N,s as F,n as Z,u as ee}from"./app-B4kV47qU.js";import{_ as A}from"./ShortCodes-4WIx1doN.js";import{_ as j}from"./Modal-ChMy0A7y.js";import ae from"./OverviewGrid-8XiXRoFO.js";import{_ as te}from"./NoDataFound-su6Kbmdk.js";import{_ as se}from"./RangeSlider-Cql1TtbG.js";import{_ as y}from"./SpinnerBtn-B3fjBeDL.js";import{s as le}from"./sharedComposable-VJJUONp6.js";import{t as g}from"./toastComposable-CvcyPmJb.js";import{_ as ne}from"./UserLayout-DG2qUs8x.js";import{u as oe}from"./modalStore-BgORG3Nn.js";import{_ as G}from"./MultiSelect-Ba8gY0R1.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ToastrContainer-Cfx6wOd2.js";import"./AssetModal-vtiWQmiY.js";import"./IntersectionObserver-DbdokySM.js";import"./assetStore-cDK0Afhq.js";import"./multiselect-Bn1369QT.js";const ue={key:0,class:"flex justify-end gap-2"},ie={class:"table-responsive mt-3 w-full"},de={class:"table"},re={class:"!text-right"},me={key:0,class:"tbody"},ve={key:0},ge={key:1},pe={key:2},ce={class:"!text-right"},fe=["disabled","onClick"],_e={class:"space-y-2"},he={for:"device_rotation_duration",class:"label mb-1.5"},be={class:"label mb-1"},ye={value:"template"},xe={value:"text"},Se={key:0},ke={class:"label mb-1"},Me={value:"undefined",disabled:"",selected:""},Ce=["value"],Ve={key:1},Ne={class:"label mb-1"},we={class:"flex justify-end"},Te={class:"space-y-2"},Ie={class:"label mb-1"},Ue={key:0},$e={class:"label mb-1"},Be={class:"flex justify-end"},Ze=Object.assign({layout:ne},{__name:"Create",props:["platforms","templates","groups"],setup(x){const L=x,{badgeClass:J}=le(),w=oe();X(()=>{w.open("configBulkSend")});const P=U(()=>{var a,s,r;return[{title:"Total Messages",value:c.value?e.value.contactIndex+1:0,icon:"bx:message"},{title:"Failed Messages",value:((a=u.value)==null?void 0:a.filter(l=>l.status==="failed").length)||0,icon:"bx:x-circle"},{title:"Pending Messages",value:((s=u.value)==null?void 0:s.filter(l=>l.status==="pending").length)||0,icon:"bx:user"},{title:"Sent Messages",value:((r=u.value)==null?void 0:r.filter(l=>l.status==="sent").length)||0,icon:"bx:check-circle"}]}),e=f({group_ids:[],platforms_ids:[],message_type:"text",message_delay:[1,60],loading:!1,contactIndex:0}),S=f({contacts:""}),p=f(!1),c=f(!1),T=f(!1),u=f([]),k=f([]),R=()=>{if(c.value)return g.danger("Cannot configure after sending messages");if(e.value.group_ids.length===0)return g.danger("No Groups Selected");if(!e.value.message&&!e.value.template_id)return g.danger("No Message or Template Selected");F.get(route("user.whatsapp-web.api.bulk-send.contact_list",{group_ids:e.value.group_ids})).then(a=>{u.value=a.data,k.value.length>0&&(u.value=[...u.value,...k.value])})},z=()=>{if(u.value.length===0)return g.danger("No Contacts Found");if(!e.value.message&&e.value.message_type==="text")return g.danger("No Message added");if(!e.value.template_id&&e.value.message_type==="template")return g.danger("No Template Selected");if(e.value.platforms_ids.length===0)return g.danger("No Devices Selected");p.value=!0,c.value=!0,e.value.loading=!0,C()},I=(a,s)=>a.replace(/{name}/g,s),C=()=>{var l;if(!p.value)return;setTimeout(()=>{},1e5);const a=Math.floor(Math.random()*e.value.platforms_ids.length),s=u.value[e.value.contactIndex];let r;e.value.message_type==="text"&&(r=I(e.value.message,s==null?void 0:s.name)),F.post(route("user.whatsapp-web.api.bulk-send.message"),{form:{message_type:e.value.message_type,message:r||null,template_id:((l=e.value)==null?void 0:l.template_id)||null,platform_id:e.value.platforms_ids[a]},contact:s}).then(v=>{u.value=u.value.map((n,h)=>h===e.value.contactIndex?{...n,status:"sent"}:n)}).catch(v=>{u.value=u.value.map((n,h)=>h===e.value.contactIndex?{...n,status:"failed"}:n),g.danger("Something went wrong!")}).finally(()=>{e.value.contactIndex<u.value.length-1?E():O()})},E=()=>{if(p.value){console.log("sending next message"),e.value.contactIndex++;const a=Math.floor(Math.random()*e.value.message_delay[1])+e.value.message_delay[0];setTimeout(()=>C(),a*1e3)}},O=()=>{e.value.contactIndex=0,p.value=!1,e.value.loading=!1,T.value=!0},q=()=>{p.value=!1,e.value.loading=!1},H=()=>{e.value.contactIndex<u.value.length?(p.value=!0,e.value.loading=!0,C()):g.info("All messages have been sent")},K=()=>{if(c.value)return g.danger("Cannot add contacts after sending messages");const a=S.value.contacts.split(",");if(a.length>0){const s=a.map(r=>{const[l,v]=r.includes("+")?r.split("+"):["guest",r];return{name:l||"guest",phone:v,status:"pending"}});k.value=[...k.value,...s],u.value=[...u.value,...s],S.value.contacts="",w.close("addContact")}},Q=a=>{u.value.splice(a,1)},W=U(()=>{var a;return e.value.message_type==="template"&&((a=e.value)!=null&&a.template_id)?L.templates.find(s=>s.id===e.value.template_id):null});return(a,s)=>{const r=Y("Icon");return i(),d(V,null,[m(ae,{items:P.value,grid:4},null,8,["items"]),T.value?_("",!0):(i(),d("div",ue,[e.value.loading?(i(),M(y,{key:0,onClick:q,"btn-text":"Stop Sending",classes:"btn btn-danger",icon:"bx:stop"})):_("",!0),c.value?_("",!0):(i(),M(y,{key:1,onClick:z,processing:e.value.loading,"btn-text":"Send Now",icon:"bx:rocket"},null,8,["processing"])),c.value?(i(),M(y,{key:2,onClick:H,processing:e.value.loading,"btn-text":a.trans(p.value?"Sending...":"Continue Sending")},null,8,["processing","btn-text"])):_("",!0)])),t("div",ie,[t("table",de,[t("thead",null,[t("tr",null,[t("th",null,o(a.trans("Name")),1),t("th",null,o(a.trans("Group")),1),t("th",null,o(a.trans("Phone")),1),t("th",null,o(a.trans("Message/Template")),1),t("th",null,o(a.trans("Status")),1),t("th",re,o(a.trans("Action")),1)])]),u.value.length?(i(),d("tbody",me,[(i(!0),d(V,null,$(u.value,(l,v)=>{var n,h;return i(),d("tr",{key:v},[t("td",null,o(l.name),1),t("td",null,o((l==null?void 0:l.group_name)||a.trans("None")),1),t("td",null,o(l.phone),1),t("td",null,[e.value.message_type==="template"?(i(),d("span",ve,o(((n=W.value)==null?void 0:n.name)||a.trans("None")),1)):e.value.message_type==="text"?(i(),d("span",ge,o((h=e.value)!=null&&h.message?I(e.value.message,l.name):a.trans("None")),1)):(i(),d("span",pe,o(a.trans("None")),1))]),t("td",null,[t("span",{class:Z(ee(J)(l.status))},o(l.status),3)]),t("td",ce,[t("button",{disabled:e.value.loading||c.value,class:"btn btn-sm btn-danger",onClick:De=>Q(v)},[m(r,{icon:"bx:trash"})],8,fe)])])}),128))])):(i(),M(te,{key:1,forTable:!0}))])]),m(j,{backdropClose:!1,closeBtn:!0,"header-state":!0,"header-title":"Configure Bulk Send",state:"configBulkSend"},{default:B(()=>{var l,v;return[t("div",_e,[m(G,{label:"Select Rotation Devices",modelValue:e.value.platforms_ids,"onUpdate:modelValue":s[0]||(s[0]=n=>e.value.platforms_ids=n),placeholder:"Select Rotation Devices",validationMessage:(l=e.value.errors)==null?void 0:l.platforms_ids,options:x.platforms},null,8,["modelValue","validationMessage","options"]),t("div",null,[t("label",he,o(a.trans("Message Delay (in seconds)")),1),m(se,{class:"px-3",min:1,max:60,modelValue:e.value.message_delay,"onUpdate:modelValue":s[1]||(s[1]=n=>e.value.message_delay=n),step:1},null,8,["modelValue"])]),m(G,{label:"Select Groups",modelValue:e.value.group_ids,"onUpdate:modelValue":s[2]||(s[2]=n=>e.value.group_ids=n),placeholder:"Select Groups",validationMessage:(v=e.value.errors)==null?void 0:v.group_ids,options:x.groups},null,8,["modelValue","validationMessage","options"]),t("div",null,[t("label",be,o(a.trans("Message Type")),1),b(t("select",{"onUpdate:modelValue":s[3]||(s[3]=n=>e.value.message_type=n),class:"select"},[t("option",ye,o(a.trans("Template")),1),t("option",xe,o(a.trans("Text")),1)],512),[[D,e.value.message_type]])]),e.value.message_type==="template"?(i(),d("div",Se,[t("label",ke,o(a.trans("Select Template")),1),b(t("select",{"onUpdate:modelValue":s[4]||(s[4]=n=>e.value.template_id=n),class:"select"},[t("option",Me,o(a.trans("Select Template")),1),(i(!0),d(V,null,$(x.templates,n=>(i(),d("option",{key:n.id,value:n.id},o(n.name),9,Ce))),128))],512),[[D,e.value.template_id]])])):_("",!0),e.value.message_type==="text"?(i(),d("div",Ve,[t("label",Ne,o(a.trans("Message")),1),b(t("textarea",{name:"message","onUpdate:modelValue":s[5]||(s[5]=n=>e.value.message=n),class:"textarea"},null,512),[[N,e.value.message]]),m(A,{modelValue:e.value.message,"onUpdate:modelValue":s[6]||(s[6]=n=>e.value.message=n)},null,8,["modelValue"])])):_("",!0),t("div",we,[m(y,{onClick:R,"btn-text":a.trans("Save")},null,8,["btn-text"])])])]}),_:1}),m(j,{"header-state":!0,"header-title":"Add Contact",state:"addContact"},{default:B(()=>[t("div",Te,[t("div",null,[t("label",Ie,o(a.trans("Contacts")),1),b(t("textarea",{placeholder:"Use comma to separate multiple contacts, e.g. John+1234567890, Jane+0987654321",name:"contacts","onUpdate:modelValue":s[7]||(s[7]=l=>S.value.contacts=l),class:"textarea max-h-40"},null,512),[[N,S.value.contacts]])]),e.value.message_type==="text"?(i(),d("div",Ue,[t("label",$e,o(a.trans("Message")),1),b(t("textarea",{name:"message","onUpdate:modelValue":s[8]||(s[8]=l=>e.value.message=l),class:"textarea max-h-40",placeholder:"Message"},null,512),[[N,e.value.message]]),m(A,{modelValue:e.value.message,"onUpdate:modelValue":s[9]||(s[9]=l=>e.value.message=l)},null,8,["modelValue"])])):_("",!0),t("div",Be,[m(y,{onClick:K,"btn-text":a.trans("Add Contact")},null,8,["btn-text"])])])]),_:1})],64)}}});export{Ze as default};
